<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Arbitrage Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card-custom { margin-bottom: 1rem; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4">ðŸ’° Crypto Arbitrage Dashboard</h2>

  <!-- Settings Panel -->
  <div class="card card-custom">
    <div class="card-header">Settings</div>
    <div class="card-body">
      <form id="settings-form">
        <div class="row g-3">
          <div class="col-md-2"><input class="form-control" name="stake" type="number" step="0.01" placeholder="Stake"></div>
          <div class="col-md-2"><input class="form-control" name="target_profit" type="number" step="0.01" placeholder="Profit %"></div>
          <div class="col-md-2"><input class="form-control" name="max_trades" type="number" placeholder="Max Trades"></div>
          <div class="col-md-2"><input class="form-control" name="cooldown" type="number" placeholder="Cooldown (s)"></div>
          <div class="col-md-2">
            <select name="reinvest" class="form-select">
              <option value="true">Reinvest: Yes</option>
              <option value="false">Reinvest: No</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Live Prices -->
  <div class="row">
    <div class="col-md-6">
      <div class="card card-custom">
        <div class="card-header">Bitcoin (BTC)</div>
        <div class="card-body" id="btc-price">Loading...</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card card-custom">
        <div class="card-header">Ethereum (ETH)</div>
        <div class="card-body" id="eth-price">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card card-custom">
    <div class="card-header">ðŸ“ˆ Backtest Performance</div>
    <div class="card-body">
      <canvas id="profitChart" height="120"></canvas>
    </div>
  </div>
</div>

<script>
  async function fetchPrices() {
    const res = await fetch('/prices');
    const data = await res.json();
    document.getElementById("btc-price").textContent = data.bitcoin?.usd ? `$${data.bitcoin.usd}` : 'Error';
    document.getElementById("eth-price").textContent = data.ethereum?.usd ? `$${data.ethereum.usd}` : 'Error';
  }

  async function loadSettings() {
    const res = await fetch('/settings');
    const settings = await res.json();
    for (let key in settings) {
      const el = document.querySelector(`[name="${key}"]`);
      if (el) el.value = settings[key];
    }
  }

  document.getElementById("settings-form").addEventListener("submit", async e => {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());
    data.reinvest = data.reinvest === "true";
    await fetch('/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    alert("Settings updated.");
  });

  async function renderChart() {
    const res = await fetch('/backtest');
    const results = await res.json();
    const ctx = document.getElementById("profitChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: results.results.map(r => r.timestamp),
        datasets: [{
          label: "Profit ($)",
          data: results.results.map(r => r.profit),
          fill: true,
          borderColor: "green",
          backgroundColor: "rgba(0,128,0,0.1)",
        }]
      }
    });
  }

  fetchPrices();
  loadSettings();
  renderChart();
  setInterval(fetchPrices, 60000);
</script>
</body>
</html>
