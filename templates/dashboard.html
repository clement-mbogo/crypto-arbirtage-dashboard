<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Arbitrage Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
    <h2 class="text-center mb-4">ðŸ’° Crypto Arbitrage Dashboard</h2>

    <!-- Settings Form -->
    <form id="settings-form" class="card p-3 mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label for="stake" class="form-label">Stake ($)</label>
                <input type="number" class="form-control" id="stake" name="stake" min="1">
            </div>
            <div class="col-md-2">
                <label for="target_profit" class="form-label">Target Profit (%)</label>
                <input type="number" class="form-control" id="target_profit" name="target_profit" min="1">
            </div>
            <div class="col-md-2">
                <label for="max_trades" class="form-label">Max Trades</label>
                <input type="number" class="form-control" id="max_trades" name="max_trades" min="1">
            </div>
            <div class="col-md-2">
                <label for="cooldown" class="form-label">Cooldown (min)</label>
                <input type="number" class="form-control" id="cooldown" name="cooldown" min="0">
            </div>
            <div class="col-md-2">
                <label for="reinvest" class="form-label">Reinvest</label>
                <select class="form-control" id="reinvest" name="reinvest">
                    <option value="true">True</option>
                    <option value="false">False</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-success w-100">Update</button>
            </div>
        </div>
    </form>

    <!-- Prices -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card p-3 text-center">
                <h5>Bitcoin (BTC)</h5>
                <h4 id="btc-price">Loading...</h4>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 text-center">
                <h5>Ethereum (ETH)</h5>
                <h4 id="eth-price">Loading...</h4>
            </div>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="card p-4 mb-4">
        <canvas id="growthChart" height="120"></canvas>
    </div>

    <!-- Backtest Button -->
    <div class="d-grid mb-5">
        <button class="btn btn-secondary" onclick="startBacktest()">Run Backtest</button>
    </div>
</div>

<script>
    function fetchPrices() {
        fetch('/prices')
            .then(res => res.json())
            .then(data => {
                document.getElementById("btc-price").innerText = "$" + (data.bitcoin?.usd || 'Error');
                document.getElementById("eth-price").innerText = "$" + (data.ethereum?.usd || 'Error');
            })
            .catch(() => {
                document.getElementById("btc-price").innerText = "Error";
                document.getElementById("eth-price").innerText = "Error";
            });
    }

    const chart = new Chart(document.getElementById('growthChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Capital Growth ($)',
                data: [],
                borderColor: 'green',
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    function updateChart() {
        fetch('/real_growth')
            .then(res => res.json())
            .then(data => {
                chart.data.labels = data.labels;
                chart.data.datasets[0].data = data.values;
                chart.update();
            });
    }

    document.getElementById("settings-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("/settings", {
            method: "POST",
            body: formData
        }).then(() => alert("Settings updated!"));
    });

    function preloadSettings() {
        fetch('/settings')
            .then(res => res.json())
            .then(data => {
                document.getElementById('stake').value = data.stake;
                document.getElementById('target_profit').value = data.target_profit;
                document.getElementById('max_trades').value = data.max_trades;
                document.getElementById('cooldown').value = data.cooldown;
                document.getElementById('reinvest').value = data.reinvest;
            });
    }

    function startBacktest() {
        fetch('/backtest')
            .then(res => res.json())
            .then(result => alert("Backtest Completed: " + JSON.stringify(result)));
    }

    preloadSettings();
    fetchPrices();
    updateChart();
    setInterval(fetchPrices, 60000);
    setInterval(updateChart, 15000);
</script>
</body>
</html>
