""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crypto Arbitrage Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="text-center mb-4">ðŸ’° Crypto Arbitrage Dashboard</h1>

        <!-- Settings -->
        <div class="card mb-4">
            <div class="card-header">Settings</div>
            <div class="card-body">
                <form id="settingsForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="stake" class="form-label">Stake</label>
                            <input type="number" class="form-control" id="stake" name="stake" value="{{ settings.stake }}">
                        </div>
                        <div class="col-md-3">
                            <label for="target_profit" class="form-label">Target Profit (%)</label>
                            <input type="number" class="form-control" id="target_profit" name="target_profit" value="{{ settings.target_profit }}">
                        </div>
                        <div class="col-md-3">
                            <label for="max_trades" class="form-label">Max Trades</label>
                            <input type="number" class="form-control" id="max_trades" name="max_trades" value="{{ settings.max_trades }}">
                        </div>
                        <div class="col-md-3">
                            <label for="cooldown" class="form-label">Cooldown (s)</label>
                            <input type="number" class="form-control" id="cooldown" name="cooldown" value="{{ settings.cooldown }}">
                        </div>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="reinvest" name="reinvest" {% if settings.reinvest %}checked{% endif %}>
                        <label class="form-check-label" for="reinvest">Reinvest Profits</label>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Save Settings</button>
                </form>
            </div>
        </div>

        <!-- Prices -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card text-white bg-dark">
                    <div class="card-body">
                        <h5 class="card-title">Bitcoin (BTC)</h5>
                        <p class="card-text" id="btcPrice">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-white bg-dark">
                    <div class="card-body">
                        <h5 class="card-title">Ethereum (ETH)</h5>
                        <p class="card-text" id="ethPrice">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart + Backtest -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Performance Chart</span>
                <button class="btn btn-secondary btn-sm" onclick="runBacktest()">Run Backtest</button>
            </div>
            <div class="card-body">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        async function fetchPrices() {
            try {
                const response = await fetch("/prices");
                if (!response.ok) throw new Error("Rate limit or fetch error");
                const data = await response.json();
                document.getElementById("btcPrice").textContent = `$${data.bitcoin}`;
                document.getElementById("ethPrice").textContent = `$${data.ethereum}`;
            } catch (err) {
                document.getElementById("btcPrice").textContent = "Error";
                document.getElementById("ethPrice").textContent = "Error";
            }
        }

        const ctx = document.getElementById('performanceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Profit Over Time',
                    data: [],
                    borderColor: 'green',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { display: true },
                    y: { display: true }
                }
            }
        });

        function updateChart(data) {
            chart.data.labels = data.labels;
            chart.data.datasets[0].data = data.values;
            chart.update();
        }

        async function runBacktest() {
            const response = await fetch("/backtest");
            const data = await response.json();
            updateChart(data);
        }

        document.getElementById("settingsForm").addEventListener("submit", async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const body = {};
            for (let [key, val] of formData.entries()) body[key] = val;
            body.reinvest = document.getElementById("reinvest").checked;
            await fetch("/settings", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            alert("Settings updated");
        });

        fetchPrices();
        setInterval(fetchPrices, 60000);
    </script>
</body>
</html>
