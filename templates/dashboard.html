<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Arbitrage Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h2 class="mb-4 text-center">ðŸ’° Crypto Arbitrage Dashboard</h2>

        <!-- Settings -->
        <div class="card mb-4">
            <div class="card-header">Settings</div>
            <div class="card-body">
                <form id="settingsForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Stake</label>
                            <input type="number" class="form-control" name="stake" id="stake" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Target Profit (%)</label>
                            <input type="number" class="form-control" name="target_profit" id="target_profit" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Max Trades</label>
                            <input type="number" class="form-control" name="max_trades" id="max_trades" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cooldown (min)</label>
                            <input type="number" class="form-control" name="cooldown" id="cooldown" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Reinvest</label>
                            <select class="form-select" name="reinvest" id="reinvest">
                                <option value="true">True</option>
                                <option value="false">False</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" type="submit">Update Settings</button>
                </form>
            </div>
        </div>

        <!-- Price Feed -->
        <div class="card mb-4">
            <div class="card-header">Live Prices</div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5>Bitcoin (BTC): <span id="btcPrice">Loading...</span></h5>
                    </div>
                    <div class="col">
                        <h5>Ethereum (ETH): <span id="ethPrice">Loading...</span></h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Performance Chart</span>
                <div>
                    <button id="liveBtn" class="btn btn-outline-success btn-sm me-2">Live</button>
                    <button id="paperBtn" class="btn btn-outline-secondary btn-sm">Paper</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="growthChart"></canvas>
            </div>
        </div>

        <!-- Backtest -->
        <div class="text-center">
            <form action="/backtest" method="post">
                <button class="btn btn-warning">Run Backtest</button>
            </form>
        </div>
    </div>

    <script>
        async function fetchPrices() {
            try {
                const res = await fetch("/prices");
                const data = await res.json();
                document.getElementById("btcPrice").textContent = `$${data.binance.BTC}`;
                document.getElementById("ethPrice").textContent = `$${data.binance.ETH}`;
            } catch (e) {
                document.getElementById("btcPrice").textContent = "Error";
                document.getElementById("ethPrice").textContent = "Error";
            }
        }

        async function fetchSettings() {
            const res = await fetch("/settings");
            const s = await res.json();
            document.getElementById("stake").value = s.stake;
            document.getElementById("target_profit").value = s.target_profit;
            document.getElementById("max_trades").value = s.max_trades;
            document.getElementById("cooldown").value = s.cooldown;
            document.getElementById("reinvest").value = s.reinvest.toString();
        }

        document.getElementById("settingsForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            const res = await fetch("/settings", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });
            if (res.ok) alert("Settings updated");
        });

        let chart;
        async function drawChart() {
            const res = await fetch("/get_chart_data");
            const data = await res.json();
            const ctx = document.getElementById("growthChart").getContext("2d");
            chart?.destroy();
            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: data.map(d => d.timestamp),
                    datasets: [
                        {
                            label: "Capital",
                            data: data.map(d => d.capital),
                            borderColor: "#28a745",
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: "Profit",
                            data: data.map(d => d.profit),
                            borderColor: "#ffc107",
                            backgroundColor: "#ffc10755",
                            type: 'bar',
                            yAxisID: 'y1'
                        },
                        {
                            label: "Trade Count",
                            data: data.map(d => d.trade_count),
                            borderColor: "#007bff",
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    stacked: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        document.getElementById("liveBtn").addEventListener("click", drawChart);
        document.getElementById("paperBtn").addEventListener("click", drawChart);

        fetchSettings();
        fetchPrices();
        drawChart();
        setInterval(fetchPrices, 30000);
    </script>
</body>
</html>
