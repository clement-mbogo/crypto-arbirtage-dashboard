<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crypto Arbitrage Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card {
      margin-bottom: 20px;
    }
    #price-display span {
      display: inline-block;
      min-width: 120px;
    }
    .form-control, .form-select {
      margin-bottom: 10px;
    }
    .btn-toggle {
      margin-right: 10px;
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4 text-center">üí∞ Crypto Arbitrage Dashboard</h1>

  <!-- Price Section -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Bitcoin (BTC)</h5>
          <p id="btc-price" class="h4 text-primary">Loading...</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Ethereum (ETH)</h5>
          <p id="eth-price" class="h4 text-success">Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <form id="settings-form" class="mb-4">
    <div class="card">
      <div class="card-header">Settings</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <label>Stake ($)</label>
            <input type="number" class="form-control" name="stake">
          </div>
          <div class="col-md-3">
            <label>Target Profit (%)</label>
            <input type="number" class="form-control" name="target_profit">
          </div>
          <div class="col-md-3">
            <label>Max Trades</label>
            <input type="number" class="form-control" name="max_trades">
          </div>
          <div class="col-md-3">
            <label>Cooldown (seconds)</label>
            <input type="number" class="form-control" name="cooldown">
          </div>
        </div>
        <div class="form-check mt-3">
          <input type="checkbox" class="form-check-input" name="reinvest" id="reinvest">
          <label class="form-check-label" for="reinvest">Reinvest Profits</label>
        </div>
        <button class="btn btn-primary mt-3" type="submit">üíæ Save Settings</button>
        <button class="btn btn-secondary mt-3 ms-2" id="run-backtest">üîÅ Run Backtest</button>
      </div>
    </div>
  </form>

  <!-- Graph -->
  <div class="card">
    <div class="card-header">üìà Performance</div>
    <div class="card-body">
      <canvas id="growth-chart" height="100"></canvas>
    </div>
  </div>
</div>

<script>
  async function fetchPrices() {
    try {
      const res = await fetch('/prices');
      const data = await res.json();
      document.getElementById('btc-price').textContent = `$${data.bitcoin}`;
      document.getElementById('eth-price').textContent = `$${data.ethereum}`;
    } catch {
      document.getElementById('btc-price').textContent = 'Error';
      document.getElementById('eth-price').textContent = 'Error';
    }
  }

  async function loadSettings() {
    const res = await fetch('/settings');
    const data = await res.json();
    for (let key in data) {
      const input = document.querySelector(`[name="${key}"]`);
      if (input) {
        input.type === 'checkbox' ? input.checked = data[key] : input.value = data[key];
      }
    }
  }

  document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);
    const settings = {};
    form.forEach((value, key) => {
      settings[key] = key === 'reinvest' ? form.get('reinvest') === 'on' : value;
    });
    await fetch('/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(settings)
    });
    alert('Settings saved!');
  });

  document.getElementById('run-backtest').addEventListener('click', async (e) => {
    e.preventDefault();
    const res = await fetch('/run_backtest');
    const result = await res.json();
    alert(`Backtest Result: ${result.result}`);
  });

  async function loadGraph() {
    const res = await fetch('/real_growth');
    const data = await res.json();
    const ctx = document.getElementById('growth-chart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          {
            label: 'Capital ($)',
            data: data.capital,
            borderColor: '#0d6efd',
            tension: 0.4
          }
        ]
      }
    });
  }

  fetchPrices();
  setInterval(fetchPrices, 60000);
  loadSettings();
  loadGraph();
</script>
</body>
</html>
